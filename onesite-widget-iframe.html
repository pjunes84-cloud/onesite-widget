<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OneSite Downloader</title>
<style>
  body{font-family:system-ui,Segoe UI,Apple SD Gothic Neo,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
  .wrap{max-width:860px;margin:0 auto;padding:40px 16px}
  h1{font-size:24px;margin:0 0 12px}
  .row{display:flex;gap:8px}
  input[type=text]{flex:1;padding:12px;border:1px solid #e2e8f0;border-radius:12px;font-size:14px}
  button{padding:12px 14px;border:1px solid #e2e8f0;border-radius:12px;background:#0f172a;color:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{border:1px solid #e2e8f0;padding:8px 10px;text-align:left;font-size:13px}
  #formatsBox{display:none}
  .muted{color:#64748b;font-size:12px;margin-top:6px}
</style>

<div class="wrap">
  <h1>영상/쇼츠 다운로드</h1>

  <div class="row">
    <input id="url" type="text" placeholder="https://youtu.be/…">
    <button id="probeBtn">포맷 탐색</button>
  </div>
  <div class="muted">※ 주소창의 <code>?api=…</code> 값은 무시하고, 내부에서 백엔드 API를 고정 사용합니다.</div>

  <div id="formatsBox">
    <table id="fmtTable">
      <thead><tr>
        <th>선택</th><th>format_id</th><th>해상도</th><th>코덱</th><th>tbr</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button id="dlBtn">선택 포맷 다운로드</button>
      <button id="capBtn" style="background:#334155">자막 JSON 추출</button>
    </div>
  </div>
</div>

<script>
  // ✅ 백엔드 API 고정 (검증된 엔드포인트)
  const API = 'https://onesite-backend.onrender.com';

  const $ = (q)=>document.querySelector(q);
  const urlInput = $("#url");
  const probeBtn = $("#probeBtn"), dlBtn = $("#dlBtn"), capBtn = $("#capBtn");
  const tableBody = $("#fmtTable tbody");
  let cachedFormats = [], selectedId = null;

  // ✅ 네트워크/캐시 이슈 줄이고 에러를 자세히 보이게
  async function postJSON(path, body){
    try{
      const r = await fetch(API + path, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        referrerPolicy: 'no-referrer',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!r.ok) {
        const txt = await r.text().catch(()=>r.statusText);
        throw new Error(`HTTP ${r.status} ${r.statusText} :: ${txt.slice(0,200)}`);
      }
      const ct = r.headers.get('content-type') || '';
      return ct.includes('application/json') ? r.json() : r.blob();
    }catch(e){
      console.error('[postJSON error]', e);
      throw e;
    }
  }

  function renderFormats(list){
    $("#formatsBox").style.display = 'block';
    tableBody.innerHTML = '';
    cachedFormats = list;
    list.forEach((f,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="radio" name="fmt" value="${f.format_id}" ${i===0?'checked':''}></td>
        <td>${f.format_id}</td>
        <td>${f.resolution || ''}</td>
        <td>${(f.vcodec||'')}/${(f.acodec||'')}</td>
        <td>${f.tbr || ''}</td>`;
      tableBody.appendChild(tr);
    });
    selectedId = list[0]?.format_id || '18';
  }

  document.addEventListener('change', e=>{
    if (e.target.name === 'fmt') selectedId = e.target.value;
  });

  probeBtn.onclick = async ()=> {
    try{
      const url = urlInput.value.trim();
      if (!url) return alert('URL을 입력하세요');
      console.log('[UI] probe start', url);
      const data = await postJSON('/api/probe', { url });
      console.log('[UI] probe OK', data.title);
      const list = (data.formats||[])
        .filter(f => (f.ext||'').includes('mp4') || /22|18|137|136|135|134|133/.test(f.format_id))
        .sort((a,b)=>{
          const ra=+(a.resolution?.split('x')[1]||0), rb=+(b.resolution?.split('x')[1]||0);
          const ta=+(a.tbr||0), tb=+(b.tbr||0);
          return (rb-ra)||(tb-ta);
        }).slice(0,30);
      if (!list.length) alert('다운로드 가능한 포맷이 비어 있습니다.');
      renderFormats(list);
    }catch(e){ alert('탐색 실패: '+ e.message); }
  };

  dlBtn.onclick = async ()=>{
    try{
      const url = urlInput.value.trim();
      if (!url) return alert('URL을 입력하세요');
      const fmt = selectedId || '18';
      console.log('[UI] download start', {fmt});
      const blob = await postJSON('/api/download', { url, format_id: fmt });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'video.mp4';
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ alert('다운로드 실패: '+ e.message); }
  };

  capBtn.onclick = async ()=>{
    try{
      const url = urlInput.value.trim();
      if (!url) return alert('URL을 입력하세요');
      const data = await postJSON('/api/captions', { url });
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'captions.json';
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ alert('자막 추출 실패: '+ e.message); }
  };
</script>
