<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OneSite Downloader</title>
<style>body{font-family:system-ui,Arial,sans-serif;background:#f8fafc;color:#0f172a;margin:0}main{max-width:860px;margin:0 auto;padding:24px}
.card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:16px;margin-top:16px}
.row{display:flex;gap:8px}input,button{padding:10px 12px;border-radius:12px;border:1px solid #e2e8f0;font-size:14px}
button{background:#0f172a;color:#fff;cursor:pointer}.muted{color:#64748b;font-size:12px;margin-top:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border-bottom:1px solid #e2e8f0;padding:8px;text-align:left}
</style></head><body><main>
<h2>영상/쇼츠 다운로드 & 자막</h2>
<div class="card">
  <div class="row">
    <input id="url" placeholder="영상 URL 붙여넣기 (YouTube/Shorts 등)"/>
    <button id="probeBtn">포맷 탐색</button>
  </div>
  <div class="muted">상단 주소창의 <b>?api=...</b> 값이 백엔드 API입니다.</div>
</div>

<div class="card" id="formatsBox" style="display:none">
  <div class="row">
    <button id="dlBtn">선택 포맷 다운로드</button>
    <button id="capBtn">자막(JSON) 추출</button>
  </div>
  <table id="fmtTable"><thead>
    <tr><th></th><th>format_id</th><th>해상도</th><th>코덱</th><th>비트레이트</th></tr>
  </thead><tbody></tbody></table>
  <div class="muted">팁: 진행형 MP4는 보통 <b>22(720p)</b> 또는 <b>18(360p)</b> 입니다.</div>
</div>

<div class="card"><div class="muted">문의: onesite</div></div>
</main>
<script>
const qs=(k)=>new URLSearchParams(location.search).get(k);
const API='https://onesite-backend.onrender.com';   // ← 하드코딩 고정

const $=(q)=>document.querySelector(q);
const tableBody=$("#fmtTable tbody");
const probeBtn=$("#probeBtn"), dlBtn=$("#dlBtn"), capBtn=$("#capBtn");
const urlInput=$("#url"); let cachedFormats=[], selectedId=null;

// ★ 네트워크/프리플라이트 이슈를 더 확실히 보기 위한 fetch 옵션 + 상세 에러 출력
async function postJSON(path, body){
  try{
    const r=await fetch(API+path, {
      method:'POST',
      mode:'cors',
      cache:'no-store',
      referrerPolicy:'no-referrer',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body),
    });
    if(!r.ok){
      const txt=await r.text().catch(()=>r.statusText);
      throw new Error(`HTTP ${r.status} ${r.statusText} :: ${txt.slice(0,200)}`);
    }
    return r.headers.get('content-type')?.includes('application/json') ? r.json() : r.blob();
  }catch(e){
    console.error('[postJSON error]', e);
    throw e;
  }
}

function renderFormats(list){
  $("#formatsBox").style.display='block'; tableBody.innerHTML='';
  cachedFormats=list;
  list.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="radio" name="fmt" value="${f.format_id}" ${i===0?'checked':''}></td>
      <td>${f.format_id}</td><td>${f.resolution||''}</td>
      <td>${(f.vcodec||'')}/${(f.acodec||'')}</td><td>${f.tbr||''}</td>`;
    tableBody.appendChild(tr);
  });
  selectedId=list[0]?.format_id||'18';
}

document.addEventListener('change',e=>{
  if(e.target.name==='fmt') selectedId=e.target.value;
});

probeBtn.onclick=async()=>{
  try{
    const url=urlInput.value.trim(); if(!url) return alert('URL을 입력하세요');
    console.log('[UI] probe start', {API, url});
    const data=await postJSON('/api/probe',{url});
    console.log('[UI] probe OK', data.title);
    const list=(data.formats||[]).sort((a,b)=>{
      const ra=+(a.resolution?.split('x')[1]||0), rb=+(b.resolution?.split('x')[1]||0);
      const ta=+(a.tbr||0), tb=+(b.tbr||0);
      return (rb-ra)||(tb-ta);
    }).slice(0,20);
    renderFormats(list);
  }catch(e){ alert('탐색 실패: '+e.message); }
};

dlBtn.onclick=async()=>{
  try{
    const url=urlInput.value.trim(); if(!url) return alert('URL을 입력하세요');
    const fmt=selectedId||'18';
    console.log('[UI] download start', {fmt});
    const blob=await postJSON('/api/download',{url,format_id:fmt});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='video.mp4';
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ alert('다운로드 실패: '+e.message); }
};

capBtn.onclick=async()=>{
  try{
    const url=urlInput.value.trim(); if(!url) return alert('URL을 입력하세요');
    const data=await postJSON('/api/captions',{url});
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='captions.json';
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ alert('자막 추출 실패: '+e.message); }
};
</script>
